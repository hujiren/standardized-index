<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sutpc.its.dao.IMonitorEarlyWarningDao">
  <select id="getEveryBlockTpi" resultType="map" parameterType="map">
    select b.fid ,b.fname ,floor((a.period-1)/3+1) period ,round(avg(a.tpi),2) tpi from
    t_tpi_block_status a
    left join t_base_block b on a.block_fid = b.fid
    where 1=1
    and a.fdate = #{time}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by b.fid,b.fname,floor((a.period-1)/3+1)
    order by b.fid,b.fname,floor((a.period-1)/3+1)
  </select>
  <select id="getCityAndEveryDistrictTpi" resultType="map" parameterType="map">
    select * from (
    select b.fid,b.fname,
    floor((a.period - 1) / 3 + 1) period,
    round(avg(a.tpi), 2) tpi
    from t_tpi_district_tpi a
    left join t_base_district b on a.district_fid = b.fid
    where a.fdate = #{time}
    <if test="homePagePeriod15 == null ">
      and floor((a.period-1)/3+1) &lt;= #{period15}
    </if>

    <if test="homePagePeriod15 != null ">
      and floor((a.period-1)/3+1) &lt;= #{homePagePeriod15}
    </if>
    <if test="config_district_fid != null and config_district_fid != ''">
      and a.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
      <!-- and a.district_fid &lt; 100 -->
    </if>
    group by b.fid,b. fname, floor((a.period - 1) / 3 + 1)
    order by b.fid,b.fname, floor((a.period - 1) / 3 + 1)
    )
    <!-- <if test="config_district_fid_flag !=1 or config_district_fid_flag == null or config_district_fid_flag == ''">
       union all
       select * from (
       select b.fid,b.fname,
       floor((a.period - 1) / 3 + 1) period,
       round(avg(a.tpi), 2) tpi
       from t_tpi_district_tpi a
       left join t_base_district b on a.district_fid = b.fid
       where a.fdate = #{time}
       and floor((a.period-1)/3+1) &lt;= #{period15}
       and a.district_fid &gt; 100
       group by b.fid,b.fname, floor((a.period - 1) / 3 + 1)
       order by b.fid,b.fname, floor((a.period - 1) / 3 + 1)
       )
     </if>-->
  </select>
  <select id="getBlockRealTimeTrafficOperationRanking" parameterType="map" resultType="map">
    select t.*,rownum from (
    select b.fid fid,b.fname fname,floor((a.period-1)/3+1) period,
    round(sum(a.total_length)/sum(a.total_time)*3.6,1) speed,round(avg(a.tpi),2) tpi from
    t_tpi_block_status a
    left join t_base_block b on a.block_fid = b.fid
    where 1=1
    and a.fdate = #{time}
    and floor((a.period-1)/3+1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by b.fid ,b.fname,floor((a.period-1)/3+1)
    order by b.fid, b.fname,floor((a.period-1)/3+1)
    ) t
    <if test="isJam == 1">
      where rownum &lt;= 10
    </if>
    <if test="isJam == 2"></if>
    <if test="isJam == 3">
      where rownum &lt;= #{dataNum}
    </if>
  </select>
  <select id="getRealTimeTrafficOperationRanking" resultType="java.util.Map" parameterType="java.util.Map">
    select t.*, rownum
    from (
    select a.fid,
    a.fname,
    floor((b.period - 1) / 3 + 1) period,
    round(sum(b.total_length) / sum(b.total_time) * 3.6, 1) speed,
    round(avg(c.tpi), 2) tpi
    from t_base_district a, t_tpi_district_speed b, t_tpi_district_tpi c
    where a.fid = b.district_fid
    and b.district_fid = c.district_fid
    and b.fdate = c.fdate
    and b.period = c.period
    and a.fid &lt; 100
    <if test="config_district_fid != null and config_district_fid != ''">
      and a.fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    and floor((b
    .period - 1) / 3 + 1) = #{period15}
    and road_type_fid in
    <foreach collection="operation_ranking_road_type_fid" item="item" separator="," open="("
      close=")">#{item}
    </foreach>
    and b.fdate
    = #{time}
    group by a.fid, a.fname, floor((b.period - 1) / 3 + 1)
    order by tpi desc
    ) t

    <if test="isJam == 1">
      where rownum &lt;= 10
    </if>
    <if test="isJam == 2"></if>
    <if test="isJam == 3">
      where rownum &lt;= #{dataNum}
    </if>

  </select>

  <select id="getDistrictCarOrBusData" parameterType="map" resultType="map">
    select floor((t.period - 1) / 3 + 1) period,
    round(sum(t.total_length) / sum(t.total_time) * 3.6, 1) speed
    from
    <if test="vehicle_type == 'car'">
      t_tpi_district_speed t
    </if>
    <if test="vehicle_type == 'bus'">
      t_bus_district_speed t
    </if>
    where 1 = 1
    and t.fdate = #{time}
    <if test="period15 !=null and period15 != ''">
      and floor((t.period-1)/3+1)&lt;=#{period15}
    </if>
    and t.district_fid = #{district_fid}
    group by floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)
  </select>
  <select id="getRealtimeBusOperationRanking" resultType="map" parameterType="map">
    select t.fname,
    t.district_fid,
    t.car_speed,
    t.bus_speed,
    round(t.car_speed / t.bus_speed, 2) speed_rate
    from (select a.district_fid,c.fname,floor((a.period-1)/3+1) period,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) car_speed,
    round(sum(b.total_length) / sum(b.total_time) * 3.6, 1) bus_speed
    from t_tpi_district_speed a
    left join t_bus_district_speed b on a.fdate = b.fdate
    and a.period = b.period
    and a.district_fid =
    b.district_fid
    left join t_base_district c on a.district_fid = c.fid
    where 1 = 1
    and a.fdate = #{time}
    and floor((a.period-1)/3+1)=#{period15}
    and c.fid &lt;100
    <if test="config_district_fid != null and config_district_fid != ''">
      and c.fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by a.district_fid,c.fname,floor((a.period-1)/3+1)) t
    order by t.bus_speed

  </select>
  <select id="getBuslaneRealTimeOperationStatus" parameterType="map" resultType="map">
    select t.buslane_fid,
    t.fname,
    t.dirname,
    t.period,
    t.car_speed,
    t.bus_speed,
    round(t.car_speed / t.bus_speed, 2) speed_rate,
    case
    when round(t.car_speed / t.bus_speed, 2)&lt;1.3 then '畅通'
    when round(t.car_speed / t.bus_speed, 2)&lt;1.5 then '基本畅通'
    when round(t.car_speed / t.bus_speed, 2)&lt;1.7 then '缓行'
    when round(t.car_speed / t.bus_speed, 2)&lt;1.9 then '较拥堵'
    when round(t.car_speed / t.bus_speed, 2)&gt;=1.9 then '拥堵'
    end status
    from (select a.buslane_fid,
    c.fname,
    d.fname as dirname,
    floor((a.period - 1) / 3 + 1) period,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) car_speed,
    round(sum(b.total_length) / sum(b.total_time) * 3.6, 1) bus_speed
    from t_tpi_road_buslane_speed a
    left join t_bus_road_buslane_speed b
    on a.fdate = b.fdate and a.period = b.period and a.buslane_fid = b.buslane_fid
    left join t_base_buslane c on c.fid = a.buslane_fid
    left join t_base_direction d on c.dir_fid = d.fid
    where a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    group by a.buslane_fid, c.fname, d.fname, floor((a.period - 1) / 3 + 1)) t
    order by speed_rate desc
  </select>


  <select id="getSubsectRealTimeJamWarning" resultType="map" parameterType="map">
    select t.*, rownum
    from (select floor((a.period - 1) / 3 + 1) period,
    a.subsect_fid,
    b.fname,
    round(avg(a.tpi), 2) tpi,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed
    from t_tpi_subsect_status a, t_base_subsect b
    where a.subsect_fid = b.fid
    and b.is_show = 1
    and a.fdate = #{time}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" separator="," item="item" open="(" close=")">
        #{item}
      </foreach>
    </if>
    <if test="isJam == null or isJam == ''">
      and a.tpi &gt;= #{subsect_real_time_jam_tpi_critical_point}
    </if>
    and floor((a.period - 1) / 3 + 1) = #{period15}
    group by floor((a.period - 1) / 3 + 1), a.subsect_fid, b.fname
    order by floor((a.period - 1) / 3 + 1), tpi desc) t
    <if test="isJam == 1">
      where rownum &lt;= #{subsect_real_time_jam_max}
    </if>
    <if test="isJam == 2"></if>
    <if test="isJam == 3">
      where rownum &lt;= #{dataNum}
    </if>
  </select>
  <select id="getSpeedAndTpiInfoBySubsectfid" resultType="map" parameterType="map">
    select floor((t.period - 1) / 3 + 1) period,
    round(avg(t.tpi), 2) tpi,
    round(sum(t.total_length) / sum(t.total_time) * 3.6, 1) speed
    from t_tpi_subsect_status t
    where t.fdate = #{time}
    and floor((t.period - 1) / 3 + 1) &lt;= #{period15}
    and subsect_fid = #{subsect_fid}
    group by floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)
  </select>
  <select id="getSubsectRealTimeTrafficStatus" resultType="map" parameterType="map">
    select t.*,
    case
    when t.tpi >= 8 then
    '拥堵'
    when t.tpi >= 6 then
    '较拥堵'
    when t.tpi >= 4 then
    '缓行'
    when t.tpi >= 2 then
    '基本畅通'
    else
    '畅通'
    end as status
    from (select floor((a.period - 1) / 3 + 1) period,
    a.subsect_fid,
    b.fname,
    round(avg(a.tpi), 2) tpi,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed
    from t_tpi_subsect_status a, t_base_subsect b
    where a.subsect_fid = b.fid
    and b.is_show = 1
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" separator="," item="item" open="(" close=")">
        #{item}
      </foreach>
    </if>
    <if test="subsect_real_time_status_fid != null">
      and a.subsect_fid in
      <foreach collection="subsect_real_time_status_fid" item="item" separator="," open="("
        close=")">
        #{item}
      </foreach>
    </if>
    group by floor((a.period - 1) / 3 + 1), a.subsect_fid, b.fname
    order by floor((a.period - 1) / 3 + 1), tpi desc) t
  </select>

  <select id="getPoiRealTimeJamWarning" parameterType="map" resultType="map">
    select t.*, rownum
    from (select floor((a.period - 1) / 3 + 1) period,
    a.poi_fid,
    b.fname,
    round(avg(a.tpi), 2) tpi,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed
    from t_tpi_poi_status a, t_base_poi b
    where a.poi_fid = b.fid
    and b.is_show = 1
    and a.sample_vehicle > 20
    and a.fdate = #{time}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" separator="," item="item" open="(" close=")">
        #{item}
      </foreach>
    </if>
    <if test="isJam == null or isJam == ''">
      and a.tpi &gt;= #{poi_real_time_jam_tpi_critical_point}
    </if>
    and floor((a.period - 1) / 3 + 1) = #{period15}
    group by floor((a.period - 1) / 3 + 1), a.poi_fid, b.fname
    order by floor((a.period - 1) / 3 + 1), tpi desc) t
    <if test="isJam == 1">
      where rownum &lt;= #{poi_real_time_jam_max}
    </if>
    <if test="isJam == 2"></if>
    <if test="isJam == 3">
      where rownum &lt;= #{dataNum}
    </if>
  </select>
  <select id="getSpeedAndTpiInfoByPoifid" resultType="map" parameterType="map">
    select floor((t.period - 1) / 3 + 1) period,
    round(avg(t.tpi), 2) tpi,
    round(sum(t.total_length) / sum(t.total_time) * 3.6, 1) speed
    from t_tpi_poi_status t
    where t.fdate = #{time}
    and floor((t.period - 1) / 3 + 1) &lt;= #{period15}
    and poi_fid = #{poi_fid}
    group by floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)
  </select>
  <select id="getPoiRealTimeTrafficStatus" parameterType="map" resultType="map">
    select floor((a.period - 1) / 3 + 1) period,
    a.poi_fid,
    b.fname,
    b.poi_lat,
    b.poi_lng,
    b.poi_type,
    round(avg(a.tpi), 2) tpi,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed
    from t_tpi_poi_status a, t_base_poi b
    where a.poi_fid = b.fid
    and b.is_show != 0
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" separator="," item="item" open="(" close=")">
        #{item}
      </foreach>
    </if>
    <if test="poi_real_time_status_fid != null">
      and a.poi_fid in
      <foreach collection="poi_real_time_status_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    and b.poi_type in (1,2,3,4,5,6,7)
    group by floor((a.period - 1) / 3 + 1),
    a.poi_fid,
    b.fname,
    b.poi_lat,
    b.poi_lng,
    b.poi_type
    order by tpi desc
  </select>

  <select id="getBlockRealTimeJamWarning" parameterType="map" resultType="map">
    select t.*, rownum
    from (select floor((a.period - 1) / 3 + 1) period,
    a.block_fid,
    b.fname,
    c.fid district_fid,
    c.fname district_fname,
    round(avg(a.tpi), 2) tpi,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed
    from t_tpi_block_status a, t_base_block b,t_base_district c
    where a.block_fid = b.fid
    and b.district_fid = c.fid
    and b.is_show = 1
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" separator="," item="item" open="(" close=")">
        #{item}
      </foreach>
    </if>
    <!-- <if test="isJam == null or isJam == ''">
      and a.tpi &gt;= #{block_real_time_jam_tpi_critical_point}
    </if> -->
    group by floor((a.period - 1) / 3 + 1), a.block_fid, b.fname,c.fid ,c.fname
    order by floor((a.period - 1) / 3 + 1), tpi desc) t
    <if test="isJam == 1">
      where rownum &lt;= #{block_real_time_jam_max}
    </if>
    <if test="isJam == 2">

    </if>
    <if test="isJam == 3">
      <if test="dataNum!=null and dataNum!=''">
        where rownum &lt;= #{dataNum}
      </if>
    </if>
  </select>
  <select id="getSpeedAndTpiInfoByBlockfid" resultType="map" parameterType="map">
    select floor((t.period - 1) / 3 + 1) period,
    round(avg(t.tpi), 2) tpi,
    round(sum(t.total_length) / sum(t.total_time) * 3.6, 1) speed
    from t_tpi_block_status t
    where t.fdate = #{time}
    and floor((t.period - 1) / 3 + 1) &lt;= #{period15}
    and block_fid = #{block_fid}
    group by floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)
  </select>
  <select id="getBlockRealTimeTrafficStatus" parameterType="map" resultType="map">
    select t.*,
    case
    when t.tpi >= 8 then
    '拥堵'
    when t.tpi >= 6 then
    '较拥堵'
    when t.tpi >= 4 then
    '缓行'
    when t.tpi >= 2 then
    '基本畅通'
    else
    '畅通'
    end as status
    from (select floor((a.period - 1) / 3 + 1) period,
    a.block_fid,
    b.fname,
    round(avg(a.tpi), 1) tpi,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed
    from t_tpi_block_status a, t_base_block b
    where a.block_fid = b.fid
    and b.is_show = 1
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" separator="," item="item" open="(" close=")">
        #{item}
      </foreach>
    </if>
    <if test="block_real_time_status_fid != null">
      and a.block_fid in
      <foreach collection="block_real_time_status_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by floor((a.period - 1) / 3 + 1), a.block_fid, b.fname
    order by floor((a.period - 1) / 3 + 1), tpi desc) t
  </select>

  <select id="getRoadsectRealTimeJamWarning" resultType="map" parameterType="map">
    select t.*, rownum
    from (select floor((a.period - 1) / 3 + 1) period,
    a.roadsect_fid,
    b.fname,
    b.roadsect_from,
    b.roadsect_to,
    to_char(round(sum(a.total_length) / sum(a.total_time) * 3.6, 1),'fm9999990.00') speed,
    to_char(round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2),'fm9999990.00') tpi,
    case
    when round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2) >= 8 then
    '拥堵'
    when round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2) >= 6 then
    '较拥堵'
    when round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2) >= 4 then
    '缓行'
    when round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2) >= 2 then
    '基本畅通'
    else
    '畅通'
    end as status
    from t_tpi_roadsect_speed a, t_base_roadsect b
    where a.roadsect_fid = b.fid
    and a.sample_vehicle > #{roadsect_sample_vehile}
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by floor((a.period - 1) / 3 + 1), a.roadsect_fid, b.fname,b.roadsect_from,b.roadsect_to
    <if test="isJam == null or isJam == ''">
      having round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
      2),avg(b.road_type_fid)),2) &gt;= 6
    </if>
    order by floor((a.period - 1) / 3 + 1), round(speedtoconindex(round(sum(a.total_length) /
    sum(a.total_time) * 3.6, 2),avg(b.road_type_fid)),2) desc) t
    <if test="isJam == 1">
      where rownum &lt;= 10
    </if>
    <if test="isJam == 2">

    </if>
    <if test="isJam == 3">
      <if test="dataNum != null and dataNum != ''">
        where rownum &lt;= #{dataNum}
      </if>
    </if>
  </select>
  <select id="getSpeedAndTpiInfoByRoadsectfid" parameterType="map" resultType="map">
    select a.period, a.speed, round(speedtoconindex(a.speed, b.road_type_fid),2) tpi
    from (select t.roadsect_fid,
    floor((t.period - 1) / 3 + 1) period,
    round(sum(t.total_length) / sum(t.total_time) * 3.6, 1) speed
    from t_tpi_roadsect_speed t
    where t.fdate = #{time}
    <!-- and floor((t.period - 1) / 3 + 1) &lt;= #{period15} -->
    and roadsect_fid = #{roadsect_fid}
    group by t.roadsect_fid, floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)) a,
    t_base_roadsect b
    where a.roadsect_fid = b.fid order by a.period
  </select>
  <select id="getRoadsectRealTimeTrafficStatus" resultType="map" parameterType="map">
    select t.*,
    case
    when t.tpi >= 8 then
    '拥堵'
    when t.tpi >= 6 then
    '较拥堵'
    when t.tpi >= 4 then
    '缓行'
    when t.tpi >= 2 then
    '基本畅通'
    else
    '畅通'
    end as status
    from (select floor((a.period - 1) / 3 + 1) period,
    a.roadsect_fid,
    b.fname,
    b.dir_fid,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed,
    round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2) tpi
    from t_tpi_roadsect_speed a, t_base_roadsect b
    where a.roadsect_fid = b.fid
    and a.sample_vehicle > #{roadsect_sample_vehile}
    and a.fdate = #{time}
    <if test="roadsect_fid != null and roadsect_fid != ''">
      and a.roadsect_fid = #{roadsect_fid}
    </if>
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by floor((a.period - 1) / 3 + 1), a.roadsect_fid, b.fname,b.dir_fid
    order by floor((a.period - 1) / 3 + 1), round(speedtoconindex(round(sum(a.total_length) /
    sum(a.total_time) * 3.6, 2),avg(b.road_type_fid)),2) desc) t
  </select>
  <select id="getRoadsectRealTimeTrafficStatusPredict" parameterType="map" resultType="map">
    select t.*,
    case
    when t.tpi >= 8 then
    '拥堵'
    when t.tpi >= 6 then
    '较拥堵'
    when t.tpi >= 4 then
    '缓行'
    when t.tpi >= 2 then
    '基本畅通'
    else
    '畅通'
    end as status
    from (select floor((a.predict_period - 1) / 3 + 1) period,
    a.roadsect_fid,
    b.fname,
    b.roadsect_from,
    b.roadsect_to,
    round(avg(a.speed),1) speed,
    round(speedtoconindex(round(avg(a.speed),1),avg(b.road_type_fid)),2) tpi
    from t_tpi_roadsect_prediction a, t_base_roadsect b
    where a.roadsect_fid = b.fid
    and a.fdate = #{time}
    <if test="predict_period != null and predict_period != ''">
      and floor((a.predict_period - 1) / 3 + 1) = #{predict_period}
    </if>
    <if test="roadsect_fid != null and roadsect_fid != ''">
      and a.roadsect_fid = #{roadsect_fid}
    </if>
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by floor((a.predict_period - 1) / 3 + 1), a.roadsect_fid,
    b.fname,b.roadsect_from,b.roadsect_to
    order by floor((a.predict_period - 1) / 3 +
    1),round(speedtoconindex(round(avg(a.speed),1),avg(b.road_type_fid)),2) desc) t
  </select>
  <select id="getPredictSpeedAndTpiInfoByRoadsectfid" resultType="map" parameterType="map">
    select a.period, a.speed, round(speedtoconindex(a.speed, b.road_type_fid), 2) tpi
    from (select t.roadsect_fid,
    floor((t.predict_period - 1) / 3 + 1) period,
    round(avg(t.speed), 1) speed
    from t_tpi_roadsect_prediction t
    where t.fdate = #{time}
    and roadsect_fid = #{roadsect_fid}
    group by t.roadsect_fid, floor((t.predict_period - 1) / 3 + 1)
    order by floor((t.predict_period - 1) / 3 + 1)) a,
    t_base_roadsect b
    where a.roadsect_fid = b.fid
  </select>

  <select id="getHighSpeedRealTimeJamWarning" parameterType="map" resultType="map">
    select t.*, rownum
    from (select floor((a.period - 1) / 3 + 1) period,
    a.roadsect_fid,
    b.fname,
    b.roadsect_from,
    b.roadsect_to,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed,
    round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2) tpi
    from t_tpi_gd_roadsect_speed a
    left join t_base_roadsect b on a.roadsect_fid = b.fid
    where a.sample_vehicle > #{high_speed_sample_vehicle}
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="config_district_fid != null and config_district_fid != ''">
      and b.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by floor((a.period - 1) / 3 + 1), a.roadsect_fid, b.fname,b.roadsect_from,b.roadsect_to
    <if test="isJam == null or isJam == ''">
      having round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
      2),avg(b.road_type_fid)),2) &gt;= 6
    </if>
    order by floor((a.period - 1) / 3 + 1), round(speedtoconindex(round(sum(a.total_length) /
    sum(a.total_time) * 3.6, 2),avg(b.road_type_fid)),2) desc) t
    <if test="isJam == 1">
      where rownum &lt;= 10
    </if>
    <if test="isJam == 2">

    </if>
    <if test="isJam == 3">
      <if test="dataNum != null and dataNum != ''">
        where rownum &lt;= #{dataNum}
      </if>
    </if>
  </select>
  <select id="getHighSpeedRealTimeTrafficStatus" resultType="map" parameterType="map">
    select t.*,
    case
    when t.tpi >= 8 then
    '拥堵'
    when t.tpi >= 6 then
    '较拥堵'
    when t.tpi >= 4 then
    '缓行'
    when t.tpi >= 2 then
    '基本畅通'
    else
    '畅通'
    end as status
    from (select floor((a.period - 1) / 3 + 1) period,
    a.roadsect_fid,
    b.fname,
    round(sum(a.total_length) / sum(a.total_time) * 3.6, 1) speed,
    round(speedtoconindex(round(sum(a.total_length) / sum(a.total_time) * 3.6,
    2),avg(b.road_type_fid)),2) tpi
    from t_tpi_gd_roadsect_speed a, t_base_gd_roadsect b
    where a.roadsect_fid = b.fid
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    <if test="roadsect_fid != null and roadsect_fid != ''">
      and a.roadsect_fid = #{roadsect_fid}
    </if>
    <!--
    <if test="config_district_fid != null and config_district_fid != '' and config_district_fid != ' '">
        and b.district_fid in
        <foreach collection="config_district_fid" item="item" separator=","  open="(" close=")">
            #{item}
        </foreach>
    </if>
     -->
    group by floor((a.period - 1) / 3 + 1), a.roadsect_fid, b.fname
    order by floor((a.period - 1) / 3 + 1), round(speedtoconindex(round(sum(a.total_length) /
    sum(a.total_time) * 3.6, 2),avg(b.road_type_fid)),2) desc) t
  </select>
  <select id="getHighSpeedLineDataByRoadsectfid" parameterType="map" resultType="map">
    select a.period, a.speed, round(speedtoconindex(a.speed, b.road_type_fid), 2) tpi
    from (select t.roadsect_fid,
    floor((t.period - 1) / 3 + 1) period,
    round(sum(t.total_length) / sum(t.total_time) * 3.6, 1) speed
    from t_tpi_gd_roadsect_speed t
    where t.fdate = #{time}
    and floor((t.period - 1) / 3 + 1) &lt;= #{period15}
    and roadsect_fid = #{roadsect_fid}
    group by t.roadsect_fid, floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)) a,
    t_base_roadsect b
    where a.roadsect_fid = b.fid
    order by a.period
  </select>

  <select id="getRoadSectionFlowRanking" resultType="map" parameterType="map">
    <!--
        select
           b.road_name,
           b.roadsect_name,
           a.link_fid,
           b.detect_dir,
           floor((a.period - 1) / 3 + 1) period,
           sum(a.detect_volume) detect_volume,
           round(avg(a.speed), 1) speed,
           round(sum(a.detect_volume)/(sum(b.capacity)/4),2) saturability
      from t_tpi_section_flow a
      left join t_tpi_detector_link b on a.link_fid = b.link_fid
      left join t_tpi_detector c on c.fid = b.detector_fid
     where a.fdate = #{time}
       and floor((a.period - 1) / 3 + 1) = #{period15}
       and c.fname is not null
     group by  b.road_name,b.roadsect_name, a.link_fid,b.detect_dir,c.position, floor((a.period - 1) / 3 + 1)
    -->
    select a.road_name,
    a.roadsect_name,
    a.detect_dir,
    a.link_fid,
    a.from_node,
    a.to_node,
    b.fid,
    b.detector_lng lng,
    b.detector_lat lat,
    floor((c.period-1)/3+1) period,
    round(sum(c.modified_volume)) modified_volume,
    round(sum(c.modified_volume) / (sum(a.capacity) / 4), 2) saturability,
    round(sum(d.total_length) / sum(d.total_time) * 3.6, 1) speed
    from t_tpi_detector_link a
    left join t_tpi_detector b on a.detector_fid = b.fid
    left join t_tpi_section_flow c on a.link_fid = c.link_fid
    and a.from_node = c.from_node
    and a.to_node = c.to_node
    left join t_tpi_link_speed d on d.link_fid = c.link_fid
    and d.from_node = c.from_node
    and d.to_node = c.to_node
    and d.period = c.period
    where c.fdate = 20180612
    and d.fdate = #{time}
    and floor((c.period-1)/3+1) = #{period15}
    and (a.detect_dir_fid is not null or a.detect_dir is not null)
    group by a.road_name,
    a.roadsect_name,
    a.detect_dir,
    a.link_fid,
    a.from_node,
    a.to_node,
    b.fid,
    b.detector_lng,
    b.detector_lat,
    floor((c.period-1)/3+1)
    order by saturability desc
  </select>
  <select id="getRoadSectionFlowsByLinkFid" parameterType="map" resultType="map">
    select floor((t.period - 1) / 3 + 1) period, sum(t.detect_volume) detect_volume
    from t_tpi_section_flow t
    where t.fdate = 20180612
    and floor((period - 1) / 3 + 1) &lt;=#{period15}
    and t.link_fid = #{link_fid}
    and t.from_node = #{from_node}
    and t.to_node = #{to_node}
    group by floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)
  </select>
  <select id="getCapacityByLinkFid" resultType="map" parameterType="map">
    select t.capacity
    from t_tpi_detector_link t
    where t.link_fid = #{link_fid}
    and t.from_node = #{from_node}
    and t.to_node = #{to_node}
  </select>
  <select id="getDcInfo" resultType="map" parameterType="map">
    select a.fid, a.fname, a.detector_lng lng, a.detector_lat lat, b.link_fid, b.road_name
    from t_tpi_detector a
    left join t_tpi_detector_link b on a.fid = b.detector_fid
  </select>
  <select id="getDetailInfoByLinkFid" parameterType="map" resultType="map">
    select floor((a.period - 1) / 3 + 1) period,
    sum(a.detect_volume) detect_volume,
    round(sum(a.detect_volume) / (sum(b.capacity) / 4), 2) saturability
    from t_tpi_section_flow a
    left join t_tpi_detector_link b on a.link_fid = b.link_fid
    where 1 = 1
    and a.fdate = #{time}
    and floor((a.period - 1) / 3 + 1) = #{period15}
    and a.link_fid = #{link_fid}
    group by floor((a.period - 1) / 3 + 1)
  </select>

  <!-- 断面流量新需求修改后的接口 -->
  <select id="getRoadSectFlowDistribution" resultType="map" parameterType="map">
    select a.fid as "fid",a.fname as "fname",sum(c.modified_volume) as "volume" from t_tpi_detector
    a
    left join t_tpi_detector_link b on a.fid = b.detector_fid
    left join t_tpi_section_flow c on c.from_node = b.from_node and c.to_node = b.to_node and
    c.link_fid = b.link_fid
    where c.fdate = #{roadsect_flow_time}
    and floor((c.period-1)/12+1) = #{period_hour}
    <if test="config_district_fid != null and config_district_fid != ''">
      and a.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by a.fid,a.fname
    order by a.fid
  </select>
  <select id="getDetectorDirFlowByDetectorFid" parameterType="map" resultType="map">
    select b.road_name as "fname",
    b.detect_dir_fid as "dir_fid",
    b.detect_dir as "dir",
    sum(c.modified_volume) "volume"
    from t_tpi_detector a
    left join t_tpi_detector_link b on a.fid = b.detector_fid
    left join t_tpi_section_flow c
    on c.from_node = b.from_node and c.to_node = b.to_node and c.link_fid = b.link_fid
    where 1 = 1
    and c.fdate = #{roadsect_flow_time}
    and floor((c.period - 1) / 12 + 1) = #{period_hour}
    and a.fid = #{fid}
    group by b.road_name, b.detect_dir_fid, b.detect_dir
  </select>
  <select id="getRoadSectionFlows" resultType="map" parameterType="map">
    select t.detector_fid "detector_fid",t.road_name "road_name",t.roadsect_name "roadsect_name",
    t.detect_dir "detect_dir" ,t.volume "volume",rownum from (
    select a.fid detector_fid,b.road_name,b.roadsect_name,b.detect_dir,sum(c.modified_volume) volume
    from t_tpi_detector a
    left join t_tpi_detector_link b on a.fid = b.detector_fid
    left join t_tpi_section_flow c on c.from_node = b.from_node and c.to_node = b.to_node and
    c.link_fid = b.link_fid
    where 1=1
    and b.road_name != '匝道'
    and c.fdate = #{roadsect_flow_time}
    and floor((c.period-1)/12+1) = #{period_hour}
    <if test="config_district_fid != null and config_district_fid != ''">
      and a.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by a.fid,b.road_name,b.roadsect_name,b.detect_dir
    order by volume desc
    ) t
    <if test="dataNum != null and dataNum != ''">
      where rownum &lt;=#{dataNum}
    </if>
  </select>
  <select id="getDetectorHourLineData" parameterType="map" resultType="map">
    select floor((c.period - 1) / 12 + 1) hour, sum(c.modified_volume) volume
    from t_tpi_detector a
    left join t_tpi_detector_link b on a.fid = b.detector_fid
    left join t_tpi_section_flow c
    on c.from_node = b.from_node and c.to_node = b.to_node and c.link_fid = b.link_fid
    where 1 = 1
    and c.fdate = #{roadsect_flow_time}
    and floor((c.period - 1) / 12 + 1) &lt;= #{period_hour}
    and a.fid = #{fid}
    and b.detect_dir_fid = #{detect_dir_fid}
    and b.road_type_fid = #{road_type_fid}
    group by floor((c.period - 1) / 12 + 1), b.capacity
    order by floor((c.period - 1) / 12 + 1)
  </select>
  <select id="getDetectorDirByFid" parameterType="map" resultType="map">
    select link_fid "link_fid",
    road_name "road_name",
    detect_dir_fid "detect_dir_fid",
    detect_dir "detect_dir",
    road_type_fid "road_type_fid"
    from t_tpi_detector_link
    where detector_fid = #{fid}
  </select>
  <select id="getCapacity" resultType="map" parameterType="map">
    select round(t.capacity) "capacity"
    from t_tpi_detector_link t
    where t.detect_dir_fid = #{detect_dir_fid}
    and t.detector_fid = #{fid}
    and link_fid = #{link_fid}
  </select>
  <!-- end -->


  <select id="getIntersectionDelayStatus" resultType="map" parameterType="map">
    select floor((y.period-1)/3+1) "period",t.fname "fname",t.fid "fid",t.intersection_lng
    "lng",t.intersection_lat "lat",round(avg(y.delay_time),1) "delay_time" from
    t_tpi_intersection_delay y
    left join t_base_intersection t on y.intersection_fid = t.fid
    where 1=1
    and y.fdate = (select max(fdate) from t_tpi_intersection_delay)
    and floor((y.period-1)/3+1) = (select floor(max(period)/3) from t_tpi_intersection_delay where
    fdate = (select max(fdate) from t_tpi_intersection_delay))
    <!-- and  sample>2 and TOTAL_LENGTH &lt;50*2.5*sample and speed>5 and speed &lt; 50 and delay_time>1 -->
    <if test="config_district_fid != null and config_district_fid != ''">
      and t.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by floor((y.period-1)/3+1),t.fname,t.fid,t.intersection_lng ,t.intersection_lat
    order by "delay_time" desc
  </select>
  <select id="getIntersectionDelayDetails" parameterType="map" resultType="map">
    select y.road_name "road_name",
    case
    when y.approach_dir = '东北' or y.approach_dir = '北' then '北'
    when y.approach_dir = '西北' or y.approach_dir = '西' then '西'
    when y.approach_dir = '西南' or y.approach_dir = '南' then '南'
    when y.approach_dir = '东南' or y.approach_dir = '东' then '东'
    end as "approach_dir",
    case
    when t.turning_dir = '直' then '直'
    when t.turning_dir = '右' then '右'
    when t.turning_dir = '掉头' or t.turning_dir = '左' then '左'
    end as "turning_dir",
    round(avg(t.delay_time), 1) "delay_time"
    from t_tpi_intersection_delay t
    left join t_base_intersection_approach y
    on y.intersection_fid = t.intersection_fid and t.from_approach_fid = y.fid
    where t.fdate = #{time}
    and t.intersection_fid = #{intersection_fid}
    group by y.road_name, y.approach_dir, t.turning_dir
    order by y.road_name
  </select>
  <select id="getIntersectionDelayDayData" resultType="map" parameterType="map">
    select floor((t.period - 1) / 3 + 1) "period", round(avg(t.delay_time), 1) "delay_time"
    from t_tpi_intersection_delay t
    where t.fdate = (select max(fdate) from t_tpi_intersection_delay)
    and floor((t.period - 1) / 3 + 1) &lt;= #{period15}
    and t.intersection_fid = #{intersection_fid}
    group by floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)
  </select>
  <select id="getIntersectionDelayDayDataRefill" resultType="map" parameterType="map">
    select floor((t.period - 1) / 3 + 1) "period", round(avg(t.delay_time), 1) "delay_time"
    from t_tpi_intersection_delay t
    where t.fdate = #{time}
    and floor((t.period - 1) / 3 + 1) &lt;= #{period15}
    and t.intersection_fid = #{intersection_fid}
    group by floor((t.period - 1) / 3 + 1)
    order by floor((t.period - 1) / 3 + 1)
  </select>


  <select id="getIntersectinDelayRanking" resultType="map" parameterType="map">
    select b.road_name, b.detect_dir, round(sum(a.modified_volume)) modified_volume
    from t_tpi_section_flow a
    left join t_tpi_detector_link b
    on a.link_fid = b.link_fid and a.from_node = b.from_node and a.to_node = b.to_node
    where a.fdate = #{time}
    and floor((a.period - 1) / 12 + 1) = #{period15}
    and (b.road_name is not null and b.detect_dir is not null)
    group by b.road_name, b.detect_dir, floor((a.period - 1) / 12 + 1)
  </select>


  <select id="getCongestionRoadNum" resultType="map" parameterType="map">
    select t1.roadsect_fid as "roadsectFid", t1.speed as "speed"
    from (select t.roadsect_fid,
    round(sum(t.total_length) / sum(t.total_time) * 3.6, 1) as speed,
    round(speedtoconindex(sum(t.total_length) / sum(t.total_time) * 3.6,
    avg(b.road_type_fid)), 2) as "index"
    from t_tpi_roadsect_speed t,
    t_base_roadsect b
    where t.fdate = #{time}
    and t.roadsect_fid = b.fid
    and t.period = #{period}
    and t.sample_vehicle &gt; 100
    group by t.roadsect_fid)t1
    where t1."index" &gt;= 6
  </select>

  <select id="getCongestionRoadTotalLength" resultType="map" parameterType="map">
    select nvl(sum(t.jam_length),0) as "totalLength"
    from t_tpi_road_jam_length t,t_base_roadsect t1
    where t1.road_fid = t.road_fid
    <if test="roadsectFidlist != null and roadsectFidlist.size > 0">
      and t1.fid in
      <foreach collection="roadsectFidlist" index="index" item="item" separator="," open="("
        close=")">
        #{item.roadsectFid}
      </foreach>
    </if>
    and t.fdate = #{time}
    and t.period_30 = #{period30}
  </select>

  <select id="getCongestionWarnReal" resultType="map" parameterType="map">
    select t2.fid as "roadsectFid",t2.fname as "roadsectName",t2.roadsect_from as
    "roadsectFrom",floor((t3.period-1)/3+1) as "period",t2.roadsect_to as "roadsectTo",
    t1.congestion_type as "congestionType",round(sum(t3.total_length) / sum(t3.total_time) * 3.6, 1)
    as "speed",
    round(speedtoconindex(sum(t3.total_length)/sum(t3.total_time)*3.6, avg(t2.road_type_fid)),2) as
    "tpi"
    from T_TPI_ROADSECT_CONGESTION t1 ,t_base_roadsect t2 ,t_tpi_roadsect_speed t3,t_base_district
    t4
    where t1.roadsect_fid = t2.fid
    and t2.fid = t3.roadsect_fid
    and t3.fdate = #{time}
    and floor((t3.period-1)/3+1) = #{period15}
    and t2.district_fid = t4.fid
    <if test="config_district_fid != null and config_district_fid != ''">
      and t4.fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by t2.fid,t2.fname,t2.roadsect_from,t2.roadsect_to,
    t1.congestion_type,floor((t3.period-1)/3+1)
  </select>

  <select id="getSpeedAndTpiById" resultType="com.sutpc.its.vo.SpeedAndTpiChartVo">
    select
    floor((a.period-1)/3+1) as "period",
    sum(a.total_length)/sum(a.total_time)*3.6 as "speed",
    speedtoconindex(sum(a.total_length)/sum(a.total_time)*3.6,avg(b.road_type_fid)) as "tpi"
    from t_tpi_roadsect_speed a
    left join t_base_roadsect b on a.roadsect_fid = b.fid
    where fdate = #{time} and floor((a.period-1)/3+1) &lt;=#{period15} and a.roadsect_fid = #{id}
    group by floor((a.period-1)/3+1)
    order by 1
  </select>

  <select id="getVolumeById" resultType="com.sutpc.its.vo.VolumeChartVo">
    select period_15 as "period",volume as "volume" from t_tpi_roadsect_volume
    where fdate = #{time} and period_15 &lt;= #{period15} and roadsect_fid = #{id} order by 1
  </select>

  <select id="getMapRealVolume" resultType="com.sutpc.its.vo.RoadsectMapVolumeVo">
    select
    a.roadsect_fid as "id",
    a.volume as "volume"
    from t_tpi_roadsect_volume a
    left join (select * from t_base_roadsect where road_type_fid in (2,3,4,5) ) b on a.roadsect_fid
    = b.fid
    where fdate = #{time} and period_15 = #{period15}
  </select>

  <select id="getCongestionWarnRealV2" resultType="com.sutpc.its.vo.CongestionWarnRealVo">
    select
    a.fid as "roadsectId",
    a.period as "period",
    b.volume as "volume",
    a.speed as "speed",
    a.*
    from (
    select t2.fid ,t2.fname as "roadsectName",t2.roadsect_from as
    "roadsectFrom",floor((t3.period-1)/3+1) as period,t2.roadsect_to as "roadsectTo",
    t1.congestion_type as "congestionType",round(sum(t3.total_length) / sum(t3.total_time) * 3.6, 1)
    as speed,
    round(speedtoconindex(sum(t3.total_length)/sum(t3.total_time)*3.6, avg(t2.road_type_fid)),2) as
    "tpi"
    from T_TPI_ROADSECT_CONGESTION t1 ,t_base_roadsect t2 ,t_tpi_roadsect_speed t3,t_base_district
    t4
    where t1.roadsect_fid = t2.fid
    and t2.fid = t3.roadsect_fid
    and t3.fdate = #{time}
    and floor((t3.period-1)/3+1) = #{period15}
    and t2.district_fid = t4.fid
    and t4.fid in (1)
    group by t2.fid,t2.fname,t2.roadsect_from,t2.roadsect_to,
    t1.congestion_type,floor((t3.period-1)/3+1)) a
    left join (select * from T_TPI_ROADSECT_VOLUME where fdate = #{time}) b on a.fid =
    b.roadsect_fid and a.period = b.period_15
    order by a.speed
  </select>

  <select id="getCongestionWarnDetail" resultType="map" parameterType="map">
    select t1.start_time as "startTime",
    t1.duration as "duration",
    t1.cause_fid as "causeFid",
    t2.cause_describe as "causeDescribe",
    t2.countermeasure_fid as "countermeasureFid",
    t2.countermeasure_describe as "countermeasureDescribe",
    t1.probability as "probability",
    t2.cause_brief as "causeBrief"
    from t_tpi_roadsect_congestion t1,
    t_congestion_cause_measure t2
    where t1.cause_fid = t2.cause_fid
    and t1.roadsect_fid = #{roadsectFid}
  </select>

  <select id="getCityIndex" resultType="map" parameterType="map">
    select t1.tpi as "tpi"
    from t_tpi_district_tpi t1,
    t_base_district t2
    where t1.district_fid = t2.fid
    and t2.fid = 111
    and t1.fdate = #{time}
    and t1.period = #{period}
  </select>
  <select id="getGdHighSpeedLinkStatus" resultType="map" parameterType="map">

    select
    a.fid "fid",
    a.from_node "from_node",
    a.to_node "to_node",
    b.fname "roadsect_fname",
    b.roadsect_from "roadsect_from",
    b.roadsect_to "roadsect_to",
    round(sum(c.total_length)/sum(c.total_time)*3.6,1) "speed",
    case
    when round(speedtoconindex(sum(c.total_length)/sum(c.total_time)*3.6,avg(a.road_type_fid)),2) >=
    8 then 5
    when round(speedtoconindex(sum(c.total_length)/sum(c.total_time)*3.6,avg(a.road_type_fid)),2) >=
    6 then 4
    when round(speedtoconindex(sum(c.total_length)/sum(c.total_time)*3.6,avg(a.road_type_fid)),2) >=
    4 then 3
    when round(speedtoconindex(sum(c.total_length)/sum(c.total_time)*3.6,avg(a.road_type_fid)),2) >=
    2 then 2
    when round(speedtoconindex(sum(c.total_length)/sum(c.total_time)*3.6,avg(a.road_type_fid)),2) >=
    0 then 1
    end "conclass"
    from t_base_gd_link a
    inner join t_base_gd_roadsect b on a.roadsect_fid = b.fid
    inner join (
    select * from t_tpi_gd_link_speed t
    where 1 = 1
    and t.fdate = #{time}
    <if test="period_range == 'fifteen'">
      and floor((t.period-1)/3+1)=#{period15}
    </if>
    <if test="period_range == null or period_range== '' or period_range == 'five'">
      and t.period = #{period}
    </if>

    ) c
    on (a.fid = c.link_fid)
    group by a.fid,a.from_node,a.to_node,b.fname,b.roadsect_from,b.roadsect_to
    order by 1
  </select>
  <select id="getAllIntersectionInformation" resultType="java.util.Map" parameterType="java.util.Map">
    select
        floor((y.period-1)/3+1) as "period",t.fname as "fname",t.fid as "fid",t.intersection_lng as "lng",
        t.intersection_lat as "lat",round(avg(y.delay_time),1) as "delay_time"
    from
        t_tpi_intersection_delay y
    left join t_base_intersection t on y.intersection_fid = t.fid
    where 1=1
    and y.fdate = (select max(fdate) from t_tpi_intersection_delay)
    and floor((y.period-1)/3+1) = (select floor(max(period)/3) from t_tpi_intersection_delay where
    fdate = (select max(fdate) from t_tpi_intersection_delay))
    <if test="config_district_fid != null and config_district_fid != ''">
      and t.district_fid in
      <foreach collection="config_district_fid" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    group by floor((y.period-1)/3+1),t.fname,t.fid,t.intersection_lng ,t.intersection_lat
    order by "delay_time" desc
  </select>


</mapper>